<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Carteira - Bingo do Pix</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .saldo-box { background: #e0f7fa; padding: 20px; border-radius: 10px; border: 2px solid var(--color-pix-green); margin-bottom: 20px; }
        .saldo-valor { font-size: 2.5em; font-weight: 900; color: var(--color-pix-green); display: block; }
        .historico-list { text-align: left; max-height: 300px; overflow-y: auto; }
        .hist-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .hist-valor.positivo { color: green; }
        .hist-valor.negativo { color: red; }
    </style>
</head>
<body>
    <header style="display:flex; justify-content:space-between; align-items:center; padding: 15px 30px;">
        <h1 class="title-gradient" style="font-size: 1.8em;"><a href="index.html" style="text-decoration:none; color:inherit;">BINGO DO PIX</a></h1>
        <a href="/api/player/logout" class="btn-comprar btn-perigo" style="width: auto; padding: 8px 15px; font-size: 0.9em;">Sair</a>
    </header>
    <main>
        <div class="card">
            <h2 id="welcome-msg">Olá!</h2>
            
            <div class="saldo-box">
                <span>Seu Saldo Disponível</span>
                <span class="saldo-valor" id="saldo-display">R$ --,--</span>
                <button id="btn-depositar" class="btn-comprar btn-destaque" style="margin-top: 10px;">Depositar (PIX)</button>
            </div>

            <div id="area-deposito" style="display:none; border-top: 1px dashed #ccc; padding-top: 20px; margin-bottom: 20px;">
                <h3>Quanto quer depositar?</h3>
                <input type="number" id="valor-deposito" placeholder="Ex: 50.00" style="padding: 10px; font-size: 1.2em; width: 150px; text-align: center;">
                <button id="btn-gerar-pix-deposito" class="btn-comprar btn-comprar-azul" style="width: auto;">Gerar PIX</button>
                <div id="pix-container" style="display:none; margin-top: 15px;">
                    <img id="qrcode-img" style="max-width: 200px; border: 1px solid #ccc;">
                    <br>
                    <input type="text" id="copia-cola" readonly style="width: 100%; padding: 10px; margin-top: 5px;">
                    <p style="font-size: 0.9em; color: #666;">Aguardando pagamento...</p>
                </div>
            </div>

            <h3>Histórico de Transações</h3>
            <div class="historico-list" id="lista-transacoes">
                <p>Carregando...</p>
            </div>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let meuId = null;

        function formatarBRL(v) { return parseFloat(v).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }

        async function carregarDados() {
            const res = await fetch('/api/player/me');
            if(res.status === 401) { window.location.href = 'login.html'; return; }
            const data = await res.json();
            
            if(data.success) {
                meuId = data.jogador._id;
                document.getElementById('welcome-msg').textContent = `Olá, ${data.jogador.nome}!`;
                document.getElementById('saldo-display').textContent = formatarBRL(data.jogador.saldo);
                
                const lista = document.getElementById('lista-transacoes');
                lista.innerHTML = '';
                if(data.transacoes.length === 0) lista.innerHTML = '<p>Nenhuma transação ainda.</p>';
                
                data.transacoes.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'hist-item';
                    const cor = t.valor >= 0 ? 'positivo' : 'negativo';
                    const dataF = new Date(t.timestamp).toLocaleDateString('pt-BR');
                    div.innerHTML = `
                        <span>${dataF} - ${t.descricao || t.tipo}</span>
                        <span class="hist-valor ${cor}">${formatarBRL(t.valor)}</span>
                    `;
                    lista.appendChild(div);
                });
            }
        }

        document.getElementById('btn-depositar').addEventListener('click', () => {
            document.getElementById('area-deposito').style.display = 'block';
        });

        document.getElementById('btn-gerar-pix-deposito').addEventListener('click', () => {
            const val = document.getElementById('valor-deposito').value;
            if(!val || val < 1) return alert('Mínimo R$ 1,00');
            
            const btn = document.getElementById('btn-gerar-pix-deposito');
            btn.disabled = true; btn.textContent = 'Gerando...';

            socket.emit('criarDeposito', { valor: val, jogadorId: meuId }, (resp) => {
                if(resp.success) {
                    document.getElementById('pix-container').style.display = 'block';
                    document.getElementById('qrcode-img').src = `data:image/png;base64,${resp.qrCodeBase64}`;
                    document.getElementById('copia-cola').value = resp.qrCodeCopiaCola;
                    btn.style.display = 'none';
                } else {
                    alert('Erro ao gerar PIX');
                    btn.disabled = false; btn.textContent = 'Gerar PIX';
                }
            });
        });

        setInterval(carregarDados, 5000);
        carregarDados();
    </script>
</body>
</html>
